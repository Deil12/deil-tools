package org.deil.utils.datasource.config;

import com.baomidou.mybatisplus.core.MybatisConfiguration;
import com.baomidou.mybatisplus.extension.plugins.PaginationInterceptor;
import com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;
import com.jndj.platform.config.mybatisplus.custom.DataSourceEnum;
import com.jndj.platform.config.mybatisplus.custom.MultipleDataSource;
import org.apache.ibatis.plugin.Interceptor;
import org.apache.ibatis.type.JdbcType;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.jdbc.DataSourceBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;

import javax.sql.DataSource;
import java.util.HashMap;
import java.util.Map;

/**
 * @PURPOSE 
 * @DATE 2022/11/24
 */
@Configuration
@MapperScan({"org.deil.utils.datasource.mapper","org.deil.utils.datasource.mapper"})
public class DataSourceConfig {

    /**
     * mybatis-plus分页插件<br>
     * 文档：http://mp.baomidou.com<br>
     */
    @Bean
    public PaginationInterceptor paginationInterceptor() {
        return new PaginationInterceptor();
    }

    /**
     * @author yangzh
     * 配置mysql datasource
     * @return
     */
    @Bean(name = "dataSourceMysql")
    @ConfigurationProperties(prefix = "spring.datasource.mysql")
    public DataSource dataSourceMysql() {
        return DataSourceBuilder.create().build() ;
    }

    /**
     * @author yangzh
     * 配置 sql server datasource
     * @return
     */
    @Bean(name = "dataSourceSqlServer")
    @ConfigurationProperties(prefix = "spring.datasource.sqlserver")
    public DataSource dataSourceSqlServer() {
        return DataSourceBuilder.create().build() ;
    }

    /**
     * 使用枚举类 映射两个datasource
     * @param mysql
     * @param sqlServer
     * @return
     */
    @Bean
    @Primary
    public DataSource multipleDataSource(@Qualifier("dataSourceMysql") DataSource mysql,
                                         @Qualifier("dataSourceSqlServer") DataSource sqlServer) {
        MultipleDataSource multipleDataSource = new MultipleDataSource() ;
        Map<Object, Object> targetDataSources = new HashMap<>() ;
        targetDataSources.put(DataSourceEnum.dataSourceMysql.getValue(), mysql) ;
        targetDataSources.put(DataSourceEnum.dataSourceSqlServer.getValue(), sqlServer) ;
        //添加数据源
        multipleDataSource.setTargetDataSources(targetDataSources) ;
        //设置默认数据源db1
        multipleDataSource.setDefaultTargetDataSource(mysql  );
        return multipleDataSource ;
    }

    @Bean("sqlSessionFactory")
    public MybatisSqlSessionFactoryBean sqlSessionFactory() throws Exception {
        MybatisSqlSessionFactoryBean sqlSessionFactory = new MybatisSqlSessionFactoryBean() ;
        sqlSessionFactory.setDataSource(multipleDataSource(dataSourceMysql(), dataSourceSqlServer())) ;

        MybatisConfiguration configuration = new MybatisConfiguration() ;
        configuration.setJdbcTypeForNull(JdbcType.NULL) ;
        configuration.setMapUnderscoreToCamelCase(true) ;
        configuration.setCacheEnabled(false) ;
        sqlSessionFactory.setConfiguration(configuration) ;
        sqlSessionFactory.setPlugins(new Interceptor[]{ paginationInterceptor() });
        return sqlSessionFactory ;
    }

}
